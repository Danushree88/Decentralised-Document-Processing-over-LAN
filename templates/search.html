{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-search"></i> Search Documents</h4>
            </div>
            <div class="card-body">
                <form id="searchForm" class="row g-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control form-control-lg" 
                               id="searchQuery" placeholder="Enter keywords, phrases, or content to search...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-lg" id="resultLimit">
                            <option value="10">10 results</option>
                            <option value="25">25 results</option>
                            <option value="50">50 results</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Search Results</h5>
                <span id="resultCount" class="badge bg-secondary">0 results</span>
            </div>
            <div class="card-body">
                <div id="searchResults">
                    <p class="text-muted text-center">Enter a search query to find documents</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> All Documents</h5>
            </div>
            <div class="card-body">
                <div id="allDocuments">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const query = document.getElementById('searchQuery').value.trim();
    const limit = document.getElementById('resultLimit').value;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    await performSearch(query, limit);
});

async function performSearch(query, limit = 10) {
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Searching...</span></div></div>';
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=${limit}`);
        const data = await response.json();
        
        document.getElementById('resultCount').textContent = `${data.results.length} results`;
        document.getElementById('resultCount').className = data.results.length > 0 ? 'badge bg-success' : 'badge bg-secondary';
        
        if (data.results.length === 0) {
            resultsDiv.innerHTML = '<p class="text-muted text-center">No documents found matching your query</p>';
            return;
        }
        
        let html = '';
        data.results.forEach((result, index) => {
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${result.file_name}</h5>
                        <p class="card-text">${result.content}</p>
                        <div class="mb-2">
                            ${result.keywords.map(keyword => 
                                `<span class="badge bg-light text-dark me-1">${keyword}</span>`
                            ).join('')}
                        </div>
                        <small class="text-muted">
                            Score: ${result.score.toFixed(2)} | 
                            Words: ${result.metadata.word_count} | 
                            Processed: ${new Date(result.metadata.processed_time).toLocaleDateString()}
                        </small>
                    </div>
                </div>
            `;
        });
        
        resultsDiv.innerHTML = html;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error performing search: ${error.message}</div>`;
    }
}

// Load all documents
async function loadAllDocuments() {
    try {
        const response = await fetch('/api/documents');
        const data = await response.json();
        
        const docsDiv = document.getElementById('allDocuments');
        
        if (data.documents.length === 0) {
            docsDiv.innerHTML = '<p class="text-muted text-center">No documents processed yet</p>';
            return;
        }
        
        let html = '<div class="row">';
        data.documents.forEach(doc => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${doc.file_name}</h6>
                            <p class="card-text small">${doc.content_preview}</p>
                            <div class="mb-2">
                                ${doc.keywords.slice(0, 5).map(keyword => 
                                    `<span class="badge bg-light text-dark me-1">${keyword}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">
                                ${doc.word_count} words | ${(doc.file_size / 1024).toFixed(1)} KB | 
                                ${new Date(doc.processed_time).toLocaleDateString()}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        docsDiv.innerHTML = html;
    } catch (error) {
        document.getElementById('allDocuments').innerHTML = 
            `<div class="alert alert-danger">Error loading documents: ${error.message}</div>`;
    }
}

// Load all documents on page load
loadAllDocuments();
</script>
{% endblock %}