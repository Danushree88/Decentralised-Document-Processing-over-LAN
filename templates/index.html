{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <h4><i class="fas fa-network-wired"></i> Decentralized Document Processing System</h4>
            <p class="mb-0">Collaboratively process and index documents across multiple nodes on your LAN</p>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <h5><i class="fas fa-file"></i> Documents</h5>
                <h3 id="doc-count">0</h3>
                <small>Total processed</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <h5><i class="fas fa-server"></i> Nodes</h5>
                <h3 id="node-count">1</h3>
                <small>Active peers</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-warning text-dark">
            <div class="card-body">
                <h5><i class="fas fa-tasks"></i> Tasks</h5>
                <h3 id="task-count">0</h3>
                <small>In progress</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <h5><i class="fas fa-database"></i> Data</h5>
                <h3 id="data-size">0 MB</h3>
                <small>Total size</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-rocket"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/upload" class="btn btn-primary btn-lg">
                        <i class="fas fa-upload"></i> Upload Documents
                    </a>
                    <a href="/search" class="btn btn-success btn-lg">
                        <i class="fas fa-search"></i> Search Index
                    </a>
                    <a href="/nodes" class="btn btn-info btn-lg">
                        <i class="fas fa-network-wired"></i> View Network
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <p><strong>Node ID:</strong> <span id="current-node-id">Loading...</span></p>
                    <p><strong>Leader:</strong> <span id="leader-status" class="badge bg-secondary">Loading...</span></p>
                    <p><strong>Network:</strong> <span id="network-status" class="badge bg-warning">Discovering...</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Processing Statistics</h5>
            </div>
            <div class="card-body">
                <canvas id="statsChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Recent Activity</h5>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <p class="text-muted">No recent activity</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Real-time updates via Socket.IO
const socket = io();

socket.on('stats_update', function(data) {
    // Update dashboard stats
    document.getElementById('doc-count').textContent = data.index_stats.total_documents || 0;
    document.getElementById('node-count').textContent = data.peer_stats.total_peers + 1;
    document.getElementById('task-count').textContent = data.task_stats.pending_tasks || 0;
    document.getElementById('data-size').textContent = data.index_stats.total_size_mb || '0';
    
    // Update system status
    document.getElementById('current-node-id').textContent = '{{ peer_node.node_id }}';
    document.getElementById('leader-status').textContent = data.peer_stats.is_leader ? 'This Node (Leader)' : 'Another Node';
    document.getElementById('leader-status').className = data.peer_stats.is_leader ? 'badge bg-success' : 'badge bg-secondary';
    document.getElementById('network-status').textContent = `Connected (${data.peer_stats.total_peers + 1} nodes)`;
    document.getElementById('network-status').className = 'badge bg-success';
});

// Initialize chart
const ctx = document.getElementById('statsChart').getContext('2d');
const statsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Completed', 'Pending', 'Failed'],
        datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Update chart with real data
socket.on('stats_update', function(data) {
    statsChart.data.datasets[0].data = [
        data.task_stats.completed_tasks || 0,
        data.task_stats.pending_tasks || 0,
        data.task_stats.failed_tasks || 0
    ];
    statsChart.update();
});
</script>
{% endblock %}