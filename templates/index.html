<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Document Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card { transition: transform 0.2s; }
        .stats-card:hover { transform: translateY(-2px); }
        #console-output { 
            height: 200px; 
            background: #1a1a1a; 
            color: #00ff00; 
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-network-wired"></i> DocProcessor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link" href="/upload">Upload</a>
                <a class="nav-link" href="/search">Search</a>
                <a class="nav-link" href="/nodes">Nodes</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h4><i class="fas fa-network-wired"></i> Decentralized Document Processing System</h4>
                    <p class="mb-0" id="connectionStatus">Initializing system...</p>
                </div>
            </div>
        </div>

        <!-- Quick Test Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="fas fa-vial"></i> QUICK SYSTEM TEST</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-danger"><strong>If nothing works, test here first:</strong></p>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-success" onclick="testAPI('stats')">
                                <i class="fas fa-chart-bar"></i> Test Stats API
                            </button>
                            <button class="btn btn-primary" onclick="testAPI('upload')">
                                <i class="fas fa-upload"></i> Test Upload API
                            </button>
                            <button class="btn btn-info" onclick="testAPI('search')">
                                <i class="fas fa-search"></i> Test Search API
                            </button>
                            <button class="btn btn-secondary" onclick="testAPI('nodes')">
                                <i class="fas fa-network-wired"></i> Test Nodes API
                            </button>
                        </div>
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="fas fa-file"></i> Documents</h5>
                        <h3 id="doc-count">0</h3>
                        <small>Total processed</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <h5><i class="fas fa-server"></i> Nodes</h5>
                        <h3 id="node-count">1</h3>
                        <small>Active peers</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-dark">
                    <div class="card-body">
                        <h5><i class="fas fa-tasks"></i> Tasks</h5>
                        <h3 id="task-count">0</h3>
                        <small>In progress</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <h5><i class="fas fa-database"></i> Data</h5>
                        <h3 id="data-size">0 MB</h3>
                        <small>Total size</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-rocket"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/upload" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload"></i> Upload Documents
                            </a>
                            <a href="/search" class="btn btn-success btn-lg">
                                <i class="fas fa-search"></i> Search Index
                            </a>
                            <a href="/nodes" class="btn btn-info btn-lg">
                                <i class="fas fa-network-wired"></i> View Network
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="system-status">
                            <p><strong>Node ID:</strong> <span id="current-node-id">Loading...</span></p>
                            <p><strong>Status:</strong> <span id="connection-badge" class="badge bg-warning">Checking...</span></p>
                            <p><strong>Components:</strong> <span id="components-count">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> System Console</h5>
                    </div>
                    <div class="card-body">
                        <div id="console-output">
                            <div>> System starting...</div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-secondary" onclick="clearConsole()">Clear</button>
                            <button class="btn btn-sm btn-info" onclick="loadAllStats()">Refresh All</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Socket.IO client library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Console logging function
        function logToConsole(message) {
            const consoleDiv = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `<div>> [${timestamp}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '<div>> Console cleared</div>';
        }

        // Test API functions
        async function testAPI(apiType) {
            logToConsole(`üß™ Testing ${apiType} API...`);
            
            let url, successMessage;
            
            switch(apiType) {
                case 'stats':
                    url = '/api/stats';
                    successMessage = 'Stats API working';
                    break;
                case 'upload':
                    url = '/api/upload';
                    successMessage = 'Upload API working';
                    break;
                case 'search':
                    url = '/api/search?q=test&limit=5';
                    successMessage = 'Search API working';
                    break;
                case 'nodes':
                    url = '/api/nodes';
                    successMessage = 'Nodes API working';
                    break;
            }
            
            try {
                if (apiType === 'upload') {
                    // Special handling for upload test
                    const testContent = "This is a test document for the decentralized system.";
                    const blob = new Blob([testContent], { type: 'text/plain' });
                    const file = new File([blob], 'test_document.txt', { type: 'text/plain' });
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        logToConsole(`‚úÖ ${successMessage}: File uploaded successfully`);
                        document.getElementById('test-results').innerHTML = 
                            `<div class="alert alert-success">${successMessage}! Task ID: ${result.task_id}</div>`;
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } else {
                    // Standard GET request for other APIs
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    logToConsole(`‚úÖ ${successMessage}: Received data`);
                    document.getElementById('test-results').innerHTML = 
                        `<div class="alert alert-success">${successMessage}! Check console for details.</div>`;
                    
                    // Update stats if it's the stats API
                    if (apiType === 'stats') {
                        updateDashboardStats(result);
                    }
                }
            } catch (error) {
                logToConsole(`‚ùå ${apiType} API FAILED: ${error.message}`);
                document.getElementById('test-results').innerHTML = 
                    `<div class="alert alert-danger">${apiType} API failed: ${error.message}</div>`;
            }
        }

        // Update dashboard stats
        function updateDashboardStats(data) {
            const elements = {
                'doc-count': data.index_stats?.total_documents || 0,
                'node-count': (data.peer_stats?.total_peers || 0) + 1,
                'task-count': data.task_stats?.pending_tasks || 0,
                'data-size': data.index_stats?.total_size_mb || '0'
            };

            for (const [id, value] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            }
            
            // Update system status
            if (data.peer_stats) {
                document.getElementById('current-node-id').textContent = data.peer_stats.node_id || 'Unknown';
                document.getElementById('components-count').textContent = 'All systems operational';
            }
        }

        // Load all stats
        async function loadAllStats() {
            logToConsole('üîÑ Loading all system stats...');
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                updateDashboardStats(data);
                logToConsole('‚úÖ All stats updated successfully');
                
                document.getElementById('connectionStatus').textContent = 'System connected and running';
                document.getElementById('connection-badge').className = 'badge bg-success';
                document.getElementById('connection-badge').textContent = 'Connected';
            } catch (error) {
                logToConsole('‚ùå Failed to load stats: ' + error.message);
                document.getElementById('connection-badge').className = 'badge bg-danger';
                document.getElementById('connection-badge').textContent = 'Disconnected';
            }
        }

        // Initialize Socket.IO
        const socket = io();

        socket.on('connect', function() {
            logToConsole('‚úÖ WebSocket connected to server');
            document.getElementById('connection-badge').className = 'badge bg-success';
            document.getElementById('connection-badge').textContent = 'Connected (Live)';
        });

        socket.on('disconnect', function() {
            logToConsole('‚ö†Ô∏è WebSocket disconnected from server');
            document.getElementById('connection-badge').className = 'badge bg-warning';
            document.getElementById('connection-badge').textContent = 'Disconnected';
        });

        socket.on('stats_update', function(data) {
            logToConsole('üìä Live stats update received');
            updateDashboardStats(data);
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('üöÄ Page loaded, initializing system...');
            loadAllStats();
        });
    </script>
</body>
</html>